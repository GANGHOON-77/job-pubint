<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 연결 테스트 - job-pubint</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f6fa 0%, #e8eaf0 100%);
        }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1565c0 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .config-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .config-section h2 {
            color: #1e3a8a;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .config-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e4e7;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .config-input:focus {
            border-color: #1e3a8a;
            outline: none;
        }
        .button {
            background: linear-gradient(135deg, #1e3a8a 0%, #1565c0 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 10px 10px 0;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .button:active {
            transform: translateY(0);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        .data-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        .job-item {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #1e3a8a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .job-item h3 {
            color: #1e3a8a;
            margin-bottom: 10px;
        }
        .job-item .meta {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .help-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .help-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        .help-section ol {
            color: #856404;
            line-height: 1.8;
        }
        .help-section a {
            color: #1e3a8a;
            font-weight: 600;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .project-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .project-info h3 {
            color: #1e3a8a;
            margin-bottom: 10px;
        }
        .project-info .code {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            font-weight: bold;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔥 Firebase 연결 테스트</h1>
        <p>프로젝트: job-pubint</p>
    </div>

    <div class="project-info">
        <h3>📋 프로젝트 정보</h3>
        <p><strong>프로젝트 ID:</strong> <span class="code">job-pubint</span></p>
        <p><strong>서비스 계정:</strong> <span class="code">firebase-adminsdk-fbsvc@job-pubint.iam.gserviceaccount.com</span></p>
    </div>

    <div class="config-section">
        <h2>⚙️ Firebase 웹 앱 설정</h2>
        <p>Firebase Console → 프로젝트 설정 → 웹 앱에서 설정값을 복사하세요</p>
        
        <label><strong>API Key:</strong></label>
        <input type="text" id="apiKey" class="config-input" placeholder="AIzaSy..." value="">
        
        <label><strong>Auth Domain:</strong></label>
        <input type="text" id="authDomain" class="config-input" placeholder="job-pubint.firebaseapp.com" value="job-pubint.firebaseapp.com">
        
        <label><strong>Project ID:</strong></label>
        <input type="text" id="projectId" class="config-input" value="job-pubint" readonly>
        
        <label><strong>Storage Bucket:</strong></label>
        <input type="text" id="storageBucket" class="config-input" placeholder="job-pubint.appspot.com" value="job-pubint.appspot.com">
        
        <label><strong>Messaging Sender ID:</strong></label>
        <input type="text" id="messagingSenderId" class="config-input" placeholder="123456789" value="">
        
        <label><strong>App ID:</strong></label>
        <input type="text" id="appId" class="config-input" placeholder="1:123456789:web:abc123" value="">
        
        <button class="button" onclick="testConnection()">🔌 연결 테스트</button>
        <button class="button" onclick="saveConfig()">💾 설정 저장</button>
        <button class="button" onclick="loadSavedConfig()">📂 저장된 설정 불러오기</button>
        <button class="button" onclick="createSampleData()">📝 샘플 데이터 생성</button>
    </div>

    <div class="config-section">
        <h2>📊 테스트 결과</h2>
        <div id="status"></div>
        <div id="dataDisplay"></div>
    </div>

    <div class="help-section">
        <h3>💡 설정 가이드</h3>
        <ol>
            <li><strong>Firebase Console 접속:</strong> <a href="https://console.firebase.google.com/project/job-pubint/settings/general" target="_blank">프로젝트 설정 페이지</a></li>
            <li><strong>웹 앱 추가:</strong> "앱 추가" → "웹" 선택 (아직 없다면)</li>
            <li><strong>설정 복사:</strong> firebaseConfig 객체의 각 값을 위 입력란에 붙여넣기</li>
            <li><strong>Firestore 활성화:</strong> <a href="https://console.firebase.google.com/project/job-pubint/firestore" target="_blank">Firestore 페이지</a>에서 데이터베이스 생성</li>
            <li><strong>보안 규칙 (테스트용):</strong>
                <pre>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
            </li>
        </ol>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, limit, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        let app = null;
        let db = null;
        
        // 저장된 설정 불러오기
        window.loadSavedConfig = function() {
            const saved = localStorage.getItem('firebaseConfig_job_pubint');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('authDomain').value = config.authDomain || '';
                document.getElementById('projectId').value = config.projectId || '';
                document.getElementById('storageBucket').value = config.storageBucket || '';
                document.getElementById('messagingSenderId').value = config.messagingSenderId || '';
                document.getElementById('appId').value = config.appId || '';
                showStatus('info', '💾 저장된 설정을 불러왔습니다.');
            } else {
                showStatus('error', '❌ 저장된 설정이 없습니다.');
            }
        }
        
        // 설정 저장
        window.saveConfig = function() {
            const config = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };
            localStorage.setItem('firebaseConfig_job_pubint', JSON.stringify(config));
            showStatus('success', '💾 설정이 저장되었습니다.');
        }
        
        // 샘플 데이터 생성
        window.createSampleData = async function() {
            if (!db) {
                showStatus('error', '❌ 먼저 Firebase에 연결해주세요.');
                return;
            }
            
            try {
                showStatus('info', '📝 샘플 데이터 생성 중...');
                
                const sampleJobs = [
                    {
                        inst_nm: '한국사회보장정보원',
                        recruit_title: '2024년 상반기 신입직원 채용',
                        work_region: '서울',
                        recruit_person_cnt: '5',
                        inst_type_nm: '공공기관',
                        rcept_end_date: '2024-12-31',
                        reg_date: new Date().toISOString(),
                        status: 'active',
                        created_at: new Date(),
                        updated_at: new Date()
                    },
                    {
                        inst_nm: '국민건강보험공단',
                        recruit_title: '디지털 전문인력 채용',
                        work_region: '전국',
                        recruit_person_cnt: '10',
                        inst_type_nm: '공단',
                        rcept_end_date: '2024-12-25',
                        reg_date: new Date().toISOString(),
                        status: 'active',
                        created_at: new Date(),
                        updated_at: new Date()
                    },
                    {
                        inst_nm: '한국철도공사',
                        recruit_title: '철도 운영 전문직 모집',
                        work_region: '부산',
                        recruit_person_cnt: '3',
                        inst_type_nm: '공사',
                        rcept_end_date: '2024-12-20',
                        reg_date: new Date().toISOString(),
                        status: 'active',
                        created_at: new Date(),
                        updated_at: new Date()
                    }
                ];
                
                const jobsRef = collection(db, 'recruitment_jobs');
                let addedCount = 0;
                
                for (const job of sampleJobs) {
                    await addDoc(jobsRef, job);
                    addedCount++;
                }
                
                showStatus('success', `✅ ${addedCount}개의 샘플 데이터가 추가되었습니다.`);
                
                // 데이터 다시 로드
                setTimeout(() => {
                    testConnection();
                }, 1000);
                
            } catch (error) {
                console.error('샘플 데이터 생성 실패:', error);
                showStatus('error', `❌ 샘플 데이터 생성 실패: ${error.message}`);
            }
        }
        
        // 연결 테스트
        window.testConnection = async function() {
            const config = {
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                projectId: document.getElementById('projectId').value,
                storageBucket: document.getElementById('storageBucket').value,
                messagingSenderId: document.getElementById('messagingSenderId').value,
                appId: document.getElementById('appId').value
            };
            
            if (!config.apiKey) {
                showStatus('error', '❌ API Key를 입력해주세요.');
                return;
            }
            
            try {
                showStatus('info', '🔄 Firebase 초기화 중...');
                
                // 기존 앱이 있으면 삭제
                if (app) {
                    await app.delete();
                }
                
                // Firebase 초기화
                app = initializeApp(config);
                db = getFirestore(app);
                
                showStatus('success', '✅ Firebase 연결 성공!');
                
                // Firestore 테스트
                showStatus('info', '🔄 Firestore 데이터 조회 중...');
                
                try {
                    // recruitment_jobs 컬렉션 조회
                    const jobsRef = collection(db, 'recruitment_jobs');
                    const q = query(jobsRef, limit(20));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        showStatus('info', '📭 recruitment_jobs 컬렉션이 비어있습니다.');
                        document.getElementById('dataDisplay').innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <h3>📭 데이터가 없습니다</h3>
                                <p>샘플 데이터를 생성하려면 위의 "📝 샘플 데이터 생성" 버튼을 클릭하세요.</p>
                            </div>
                        `;
                    } else {
                        showStatus('success', `✅ Firestore 연결 성공! ${snapshot.size}개 문서 발견`);
                        
                        // 데이터 표시
                        let html = '<h3>📋 채용공고 데이터</h3>';
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            html += `
                                <div class="job-item">
                                    <h3>${data.recruit_title || 'N/A'}</h3>
                                    <div class="meta">🏛️ <strong>기관:</strong> ${data.inst_nm || 'N/A'}</div>
                                    <div class="meta">📍 <strong>지역:</strong> ${data.work_region || 'N/A'}</div>
                                    <div class="meta">👥 <strong>인원:</strong> ${data.recruit_person_cnt || 'N/A'}명</div>
                                    <div class="meta">💼 <strong>유형:</strong> ${data.inst_type_nm || 'N/A'}</div>
                                    <div class="meta">📅 <strong>마감일:</strong> ${data.rcept_end_date || 'N/A'}</div>
                                    <div class="meta">🔑 <strong>문서 ID:</strong> ${doc.id}</div>
                                </div>
                            `;
                        });
                        document.getElementById('dataDisplay').innerHTML = html;
                    }
                    
                } catch (error) {
                    console.error('Firestore 에러:', error);
                    if (error.code === 'permission-denied') {
                        showStatus('error', '❌ Firestore 권한 거부. 보안 규칙을 확인하세요.');
                    } else if (error.message.includes('index')) {
                        showStatus('error', '⚠️ Firestore 인덱스가 필요합니다. 콘솔에서 인덱스를 생성하세요.');
                    } else {
                        showStatus('error', `❌ Firestore 에러: ${error.message}`);
                    }
                }
                
            } catch (error) {
                console.error('Firebase 초기화 에러:', error);
                showStatus('error', `❌ Firebase 초기화 실패: ${error.message}`);
            }
        }
        
        // 상태 표시
        function showStatus(type, message) {
            const statusEl = document.getElementById('status');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            statusEl.appendChild(div);
            statusEl.scrollTop = statusEl.scrollHeight;
        }
        
        // 페이지 로드 시 저장된 설정 확인
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('firebaseConfig_job_pubint');
            if (saved) {
                loadSavedConfig();
                showStatus('info', '💾 저장된 설정을 불러왔습니다. "연결 테스트" 버튼을 클릭하세요.');
            } else {
                showStatus('info', '📝 Firebase 설정값을 입력한 후 "연결 테스트" 버튼을 클릭하세요.');
            }
        });
    </script>
</body>
</html>