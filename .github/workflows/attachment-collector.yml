name: Attachment Collector

  on:
    schedule:
      # ë§¤ì‹œê°„ ì‹¤í–‰ (UTC ê¸°ì¤€)
      - cron: '0 * * * *'
    workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

  jobs:
    collect-attachments:
      runs-on: ubuntu-latest
      timeout-minutes: 30

      steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests==2.31.0 beautifulsoup4==4.12.2 firebase-admin==6.2.0 pytz==2023.3

      - name: Create Firebase key file
        run: echo '${{ secrets.FIREBASE_CREDENTIALS }}' > firebase-key.json

      - name: Verify Firebase key file
        run: |
          # íŒŒì¼ ìƒì„± ê²€ì¦
          if [ ! -f firebase-key.json ]; then
            echo "âŒ Firebase í‚¤ íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

          # íŒŒì¼ í¬ê¸° í™•ì¸ (ë„ˆë¬´ ì‘ìœ¼ë©´ ì—ëŸ¬)
          FILE_SIZE=$(wc -c < firebase-key.json)
          if [ $FILE_SIZE -lt 100 ]; then
            echo "âŒ Firebase í‚¤ íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŒ (${FILE_SIZE} bytes)"
            echo "íŒŒì¼ ë‚´ìš© (ì²« 100ì):"
            head -c 100 firebase-key.json
            exit 1
          fi

          echo "âœ… Firebase í‚¤ íŒŒì¼ ìƒì„± ì™„ë£Œ (${FILE_SIZE} bytes)"

          # JSON í˜•ì‹ ê²€ì¦
          python -c "import json; json.load(open('firebase-key.json'))" && echo "âœ… JSON í˜•ì‹ ê²€ì¦ ì™„ë£Œ" || (echo
  "âŒ JSON í˜•ì‹ ì˜¤ë¥˜" && exit 1)

      - name: Run attachment collector
        run: python attachment_collector.py
        env:
          FIREBASE_KEY_PATH: firebase-key.json
          TZ: Asia/Seoul
        continue-on-error: true

      - name: Clean up
        if: always()
        run: |
          rm -f firebase-key.json
          echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
