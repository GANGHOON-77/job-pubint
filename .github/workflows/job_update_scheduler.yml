name: ğŸš€ ì±„ìš©ì •ë³´ ìë™ ì—…ë°ì´íŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ (ê°œì„ íŒ)

on:
  schedule:
    # ë§¤ 10ë¶„ë§ˆë‹¤ ì‹ ê·œ ì±„ìš©ê³µê³  í™•ì¸ (ë¹„ìš© ìµœì í™”: 288íšŒ/ì¼ â†’ 144íšŒ/ì¼)
    - cron: '*/10 * * * *'
    # ë§¤ì¼ ìƒˆë²½ 0ì‹œ (KST) 30ì¼ ê²½ê³¼ ì±„ìš©ê³µê³  ì •ë¦¬ (UTC 15ì‹œ = KST 0ì‹œ)
    - cron: '0 15 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ ì„ íƒ'
        required: true
        default: 'new_jobs'
        type: choice
        options:
        - new_jobs
        - cleanup
        - both
      notification_webhook:
        description: 'Slack ì›¹í›… URL (ì„ íƒì‚¬í•­)'
        required: false
        default: ''
        type: string

jobs:
  update-jobs:
    name: ì±„ìš©ì •ë³´ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 10ë¶„ ê°„ê²©ìœ¼ë¡œ ë” ë§ì€ ë°ì´í„° ì²˜ë¦¬ ì‹œê°„ í™•ë³´
    
    # ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ ì„¤ì •
    strategy:
      fail-fast: false
      matrix:
        retry: [1]  # ë‹¨ì¼ ì‹¤í–‰ì´ì§€ë§Œ ì¬ì‹œë„ êµ¬ì¡° ì¤€ë¹„
    
    # í™˜ê²½ë³€ìˆ˜ (ì „ì—­ ì„¤ì •)
    env:
      TZ: 'Asia/Seoul'  # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì •

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (ë²„ì „ ê³ ì •)
      run: |
        python -m pip install --upgrade pip
        pip install requests==2.31.0 beautifulsoup4==4.12.2 firebase-admin==6.2.0 pytz==2023.3

    - name: â° í˜„ì¬ ì‹œê°„ í™•ì¸
      id: time
      run: |
        echo "current_time=$(date)" >> $GITHUB_OUTPUT
        echo "korea_time=$(TZ='Asia/Seoul' date)" >> $GITHUB_OUTPUT
        echo "utc_time=$(date -u)" >> $GITHUB_OUTPUT
        echo "cron_minute=$(date +%M)" >> $GITHUB_OUTPUT

    - name: ğŸ” ì‹¤í–‰ ëª¨ë“œ ê²°ì • (UTC ì‹œê°„ ê¸°ì¤€ ê°œì„ )
      id: mode
      run: |
        CURRENT_UTC_HOUR=$(date -u +%H)
        CURRENT_UTC_MINUTE=$(date -u +%M)
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MODE="${{ github.event.inputs.mode }}"
        elif [ "$CURRENT_UTC_HOUR" = "15" ] && [ "$CURRENT_UTC_MINUTE" = "00" ]; then
          MODE="cleanup"
        else
          MODE="new_jobs"
        fi
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        echo "ì„ íƒëœ ì‹¤í–‰ ëª¨ë“œ: $MODE"
        echo "UTC ì‹œê°„: $(date -u)"
        echo "KST ì‹œê°„: $(TZ='Asia/Seoul' date)"

    - name: ğŸ†• ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘
      id: collect_jobs
      if: steps.mode.outputs.mode == 'new_jobs' || steps.mode.outputs.mode == 'both'
      env:
        FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        MOEF_API_KEY: ${{ secrets.MOEF_API_KEY }}
        UPDATE_MODE: 'new_jobs'
      run: |
        echo "ğŸ” ì‹ ê·œ ì±„ìš©ê³µê³  í™•ì¸ ì‹œì‘..."
        echo "í˜„ì¬ ì‹œê°: ${{ steps.time.outputs.korea_time }}"
        
        # ì—ëŸ¬ ì²´í¬ë¥¼ ìœ„í•œ ì‹¤í–‰ ì‹œê°„ ì¶”ì 
        START_TIME=$(date +%s)
        
        if ! python auto_update_jobs.py; then
          echo "job_collection_failed=true" >> $GITHUB_OUTPUT
          echo "job_collection_error=ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "job_collection_failed=false" >> $GITHUB_OUTPUT
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "job_collection_duration=${DURATION}" >> $GITHUB_OUTPUT
          echo "âœ… ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘ ì™„ë£Œ (${DURATION}ì´ˆ ì†Œìš”)"
        fi

    - name: ğŸ—‘ï¸ 30ì¼ ê²½ê³¼ ì±„ìš©ê³µê³  ì •ë¦¬
      id: cleanup_jobs
      if: steps.mode.outputs.mode == 'cleanup' || steps.mode.outputs.mode == 'both'
      env:
        FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        MOEF_API_KEY: ${{ secrets.MOEF_API_KEY }}
        UPDATE_MODE: 'cleanup'
      run: |
        echo "ğŸ—‘ï¸ 30ì¼ ê²½ê³¼ ì±„ìš©ê³µê³  ì •ë¦¬ ì‹œì‘..."
        echo "í˜„ì¬ ì‹œê°: ${{ steps.time.outputs.korea_time }}"
        
        # ì—ëŸ¬ ì²´í¬ë¥¼ ìœ„í•œ ì‹¤í–‰ ì‹œê°„ ì¶”ì 
        START_TIME=$(date +%s)
        
        if ! python auto_update_jobs.py; then
          echo "cleanup_failed=true" >> $GITHUB_OUTPUT
          echo "cleanup_error=30ì¼ ê²½ê³¼ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "cleanup_failed=false" >> $GITHUB_OUTPUT
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "cleanup_duration=${DURATION}" >> $GITHUB_OUTPUT
          echo "âœ… 30ì¼ ê²½ê³¼ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ (${DURATION}ì´ˆ ì†Œìš”)"
        fi

    # ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
    - name: ğŸš¨ ì—ëŸ¬ ì•Œë¦¼ ì „ì†¡ (Slack)
      if: failure() && (secrets.SLACK_WEBHOOK_URL != '' || github.event.inputs.notification_webhook != '')
      run: |
        WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
        if [ -n "${{ github.event.inputs.notification_webhook }}" ]; then
          WEBHOOK_URL="${{ github.event.inputs.notification_webhook }}"
        fi
        
        if [ -n "$WEBHOOK_URL" ]; then
          # ì—ëŸ¬ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
          JOB_ERROR=""
          CLEANUP_ERROR=""
          
          if [ "${{ steps.collect_jobs.outputs.job_collection_failed }}" = "true" ]; then
            JOB_ERROR="â€¢ ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘ ì‹¤íŒ¨\\n"
          fi
          
          if [ "${{ steps.cleanup_jobs.outputs.cleanup_failed }}" = "true" ]; then
            CLEANUP_ERROR="â€¢ 30ì¼ ê²½ê³¼ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨\\n"
          fi
          
          # Slack ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \":warning: **ì±„ìš©ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼**\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ğŸš¨ ì±„ìš©ì •ë³´ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ì‹¤í–‰ ì‹œê°„:*\\n${{ steps.time.outputs.korea_time }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ì‹¤í–‰ ëª¨ë“œ:*\\n${{ steps.mode.outputs.mode }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*íŠ¸ë¦¬ê±°:*\\n${{ github.event_name }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ì˜¤ë¥˜ ë‚´ìš©:*\\n${JOB_ERROR}${CLEANUP_ERROR}\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \":link: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions ë¡œê·¸ í™•ì¸>\"
                  }
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"ğŸ“Š 10ë¶„ ê°„ê²© ìŠ¤ì¼€ì¤„ (144íšŒ/ì¼) | ğŸ• UTC: ${{ steps.time.outputs.utc_time }}\"
                    }
                  ]
                }
              ]
            }" \
            "$WEBHOOK_URL"
        else
          echo "âš ï¸ ì•Œë¦¼ ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi
    
    # ì„±ê³µ ì•Œë¦¼ ì „ì†¡ (ë§¤ì¼ ì •ë¦¬ ì‘ì—… ì‹œë§Œ)
    - name: ğŸ‰ ì„±ê³µ ì•Œë¦¼ ì „ì†¡ (Slack)
      if: success() && steps.mode.outputs.mode == 'cleanup' && (secrets.SLACK_WEBHOOK_URL != '' || github.event.inputs.notification_webhook != '')
      run: |
        WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
        if [ -n "${{ github.event.inputs.notification_webhook }}" ]; then
          WEBHOOK_URL="${{ github.event.inputs.notification_webhook }}"
        fi
        
        if [ -n "$WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \":white_check_mark: **ì¼ì¼ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ**\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ğŸ‰ 30ì¼ ê²½ê³¼ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ì‹¤í–‰ ì‹œê°„:*\\n${{ steps.time.outputs.korea_time }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ì†Œìš” ì‹œê°„:*\\n${{ steps.cleanup_jobs.outputs.cleanup_duration }}ì´ˆ\"
                    }
                  ]
                },
                {
                  \"type\": \"context\",
                  \"elements\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"ğŸ—‘ï¸ ì •ê¸° ì •ë¦¬ ì™„ë£Œ | ğŸ“Š ì‹œìŠ¤í…œ ì •ìƒ ìš´ì˜ ì¤‘\"
                    }
                  ]
                }
              ]
            }" \
            "$WEBHOOK_URL"
        fi
    
    # GitHub Issuesë¥¼ í†µí•œ ì—ëŸ¬ ë¦¬í¬íŒ… (ì„ íƒì‚¬í•­)
    - name: ğŸ“ GitHub Issue ìƒì„± (ì‹¬ê°í•œ ì˜¤ë¥˜ ì‹œ)
      if: failure() && (steps.collect_jobs.outputs.job_collection_failed == 'true' || steps.cleanup_jobs.outputs.cleanup_failed == 'true')
      uses: actions/github-script@v6
      with:
        script: |
          const title = `ğŸš¨ ì±„ìš©ì •ë³´ ì‹œìŠ¤í…œ ì˜¤ë¥˜ - ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}`;
          
          let errorDetails = '';
          if ('${{ steps.collect_jobs.outputs.job_collection_failed }}' === 'true') {
            errorDetails += '- âŒ ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘ ì‹¤íŒ¨\n';
          }
          if ('${{ steps.cleanup_jobs.outputs.cleanup_failed }}' === 'true') {
            errorDetails += '- âŒ 30ì¼ ê²½ê³¼ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨\n';
          }
          
          const body = `
          ## ì˜¤ë¥˜ ìƒì„¸ ì •ë³´
          
          ${errorDetails}
          
          **ì‹¤í–‰ ì •ë³´:**
          - ğŸ• ì‹¤í–‰ ì‹œê°„: ${{ steps.time.outputs.korea_time }}
          - ğŸ”§ ì‹¤í–‰ ëª¨ë“œ: ${{ steps.mode.outputs.mode }}
          - ğŸŒ íŠ¸ë¦¬ê±°: ${{ github.event_name }}
          - ğŸ”— ì‹¤í–‰ ë¡œê·¸: [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          **ì‹œìŠ¤í…œ ì •ë³´:**
          - ğŸ“Š ìŠ¤ì¼€ì¤„: 10ë¶„ ê°„ê²© (144íšŒ/ì¼)
          - ğŸ• UTC ì‹œê°„: ${{ steps.time.outputs.utc_time }}
          - ğŸ‡°ğŸ‡· KST ì‹œê°„: ${{ steps.time.outputs.korea_time }}
          
          ---
          *ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì œ í•´ê²° í›„ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì„¸ìš”.*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'automation', 'urgent']
          });
    
    # ê²°ê³¼ ìš”ì•½ (í•­ìƒ ì‹¤í–‰)
    - name: ğŸ“Š ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "=========================================="
        echo "ğŸ¯ ì±„ìš©ì •ë³´ ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        echo "ğŸ“… ì‹¤í–‰ ì¼ì‹œ: ${{ steps.time.outputs.korea_time }}"
        echo "ğŸ”§ ì‹¤í–‰ ëª¨ë“œ: ${{ steps.mode.outputs.mode }}"
        echo "ğŸŒ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
        echo "ğŸ”„ 10ë¶„ ê°„ê²© ìŠ¤ì¼€ì¤„ (144íšŒ/ì¼)"
        echo ""
        
        # ì‹¤í–‰ ê²°ê³¼ ìƒì„¸
        if [ "${{ steps.collect_jobs.outputs.job_collection_failed }}" = "true" ]; then
          echo "âŒ ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘: ì‹¤íŒ¨"
        elif [ "${{ steps.mode.outputs.mode }}" = "new_jobs" ] || [ "${{ steps.mode.outputs.mode }}" = "both" ]; then
          echo "âœ… ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘: ì„±ê³µ (${{ steps.collect_jobs.outputs.job_collection_duration }}ì´ˆ)"
        fi
        
        if [ "${{ steps.cleanup_jobs.outputs.cleanup_failed }}" = "true" ]; then
          echo "âŒ ë°ì´í„° ì •ë¦¬: ì‹¤íŒ¨"
        elif [ "${{ steps.mode.outputs.mode }}" = "cleanup" ] || [ "${{ steps.mode.outputs.mode }}" = "both" ]; then
          echo "âœ… ë°ì´í„° ì •ë¦¬: ì„±ê³µ (${{ steps.cleanup_jobs.outputs.cleanup_duration }}ì´ˆ)"
        fi
        
        echo ""
        echo "ğŸ’° ì˜ˆìƒ ì›”ê°„ ë¹„ìš©: ~2,160ë¶„ (144íšŒ/ì¼ Ã— 30ì¼ Ã— 0.5ë¶„)"
        echo "ğŸ¯ GitHub Actions ë¬´ë£Œ í•œë„: 2,000ë¶„/ì›”"
        echo "âš ï¸  ì›”ë§ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ í•„ìš”"
        echo "=========================================="

    # ì£¼ê°„ ì‹œìŠ¤í…œ ìƒíƒœ ë³´ê³  (ì¼ìš”ì¼ ìì •ì—ë§Œ)
    - name: ğŸ“ˆ ì£¼ê°„ ì‹œìŠ¤í…œ ìƒíƒœ ë³´ê³ 
      if: success() && steps.mode.outputs.mode == 'cleanup' && format('{0}', steps.time.outputs.korea_time) == 'Sun' && (secrets.SLACK_WEBHOOK_URL != '' || github.event.inputs.notification_webhook != '')
      run: |
        WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
        if [ -n "${{ github.event.inputs.notification_webhook }}" ]; then
          WEBHOOK_URL="${{ github.event.inputs.notification_webhook }}"
        fi
        
        if [ -n "$WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \":chart_with_upwards_trend: **ì£¼ê°„ ì‹œìŠ¤í…œ ìƒíƒœ ë³´ê³ **\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ğŸ“ˆ ì±„ìš©ì •ë³´ ì‹œìŠ¤í…œ ì£¼ê°„ ë¦¬í¬íŠ¸\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ìŠ¤ì¼€ì¤„:*\\n10ë¶„ ê°„ê²© (1,008íšŒ/ì£¼)\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ì •ë¦¬ ì‘ì—…:*\\nì¼ì¼ 1íšŒ (7íšŒ/ì£¼)\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ì‹œìŠ¤í…œ ìƒíƒœ:*\\nì •ìƒ ìš´ì˜\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ë³´ê³  ì‹œì :*\\n${{ steps.time.outputs.korea_time }}\"
                    }
                  ]
                }
              ]
            }" \
            "$WEBHOOK_URL"
        fi
