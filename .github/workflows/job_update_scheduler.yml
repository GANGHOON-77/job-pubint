name: ğŸš€ ì±„ìš©ì •ë³´ ìë™ ì—…ë°ì´íŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬

on:
  schedule:
    # ë§¤ 5ë¶„ë§ˆë‹¤ ì‹ ê·œ ì±„ìš©ê³µê³  í™•ì¸
    - cron: '*/5 * * * *'
    # ë§¤ì¼ ìƒˆë²½ 0ì‹œ (KST) 30ì¼ ê²½ê³¼ ì±„ìš©ê³µê³  ì •ë¦¬ (UTC 15ì‹œ = KST 0ì‹œ)
    - cron: '0 15 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ ì„ íƒ'
        required: true
        default: 'new_jobs'
        type: choice
        options:
        - new_jobs
        - cleanup
        - both

jobs:
  update-jobs:
    name: ì±„ìš©ì •ë³´ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 firebase-admin pytz

    - name: â° í˜„ì¬ ì‹œê°„ í™•ì¸
      id: time
      run: |
        echo "current_time=$(date)" >> $GITHUB_OUTPUT
        echo "korea_time=$(TZ='Asia/Seoul' date)" >> $GITHUB_OUTPUT
        echo "cron_minute=$(date +%M)" >> $GITHUB_OUTPUT

    - name: ğŸ” ì‹¤í–‰ ëª¨ë“œ ê²°ì •
      id: mode
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          MODE="${{ github.event.inputs.mode }}"
        elif [ "$(date +%H:%M)" = "15:00" ]; then
          MODE="cleanup"
        else
          MODE="new_jobs"
        fi
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        echo "ì„ íƒëœ ì‹¤í–‰ ëª¨ë“œ: $MODE"

    - name: ğŸ†• ì‹ ê·œ ì±„ìš©ê³µê³  ìˆ˜ì§‘
      if: steps.mode.outputs.mode == 'new_jobs' || steps.mode.outputs.mode == 'both'
      env:
        FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        MOEF_API_KEY: ${{ secrets.MOEF_API_KEY }}
        UPDATE_MODE: 'new_jobs'
      run: |
        echo "ğŸ” ì‹ ê·œ ì±„ìš©ê³µê³  í™•ì¸ ì‹œì‘..."
        echo "í˜„ì¬ ì‹œê°: ${{ steps.time.outputs.korea_time }}"
        python auto_update_jobs.py

    - name: ğŸ—‘ï¸ 30ì¼ ê²½ê³¼ ì±„ìš©ê³µê³  ì •ë¦¬
      if: steps.mode.outputs.mode == 'cleanup' || steps.mode.outputs.mode == 'both'
      env:
        FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        MOEF_API_KEY: ${{ secrets.MOEF_API_KEY }}
        UPDATE_MODE: 'cleanup'
      run: |
        echo "ğŸ—‘ï¸ 30ì¼ ê²½ê³¼ ì±„ìš©ê³µê³  ì •ë¦¬ ì‹œì‘..."
        echo "í˜„ì¬ ì‹œê°: ${{ steps.time.outputs.korea_time }}"
        python auto_update_jobs.py

    - name: ğŸ“Š ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ¯ ì±„ìš©ì •ë³´ ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        echo "ğŸ“… ì‹¤í–‰ ì¼ì‹œ: ${{ steps.time.outputs.korea_time }}"
        echo "ğŸ”§ ì‹¤í–‰ ëª¨ë“œ: ${{ steps.mode.outputs.mode }}"
        echo "ğŸŒ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
        echo "========================================"
